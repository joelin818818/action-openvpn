name: åœ¨æœ€æ–°Ubuntuä¸Šè¿è¡Œè„šæœ¬å¹¶å¾ªç¯æ£€æŸ¥ç½‘ç»œ (é€šè¿‡OpenVPN) # å·¥ä½œæµåç§°

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµè¿è¡Œ
    inputs:
      parent_run_id:
        description: 'ä¸Šä¸€æ¬¡è¿è¡Œçš„ID (è‡ªåŠ¨å¡«å……)'
        required: false
        default: ''
      iteration:
        description: 'å½“å‰è¿­ä»£è®¡æ•° (è‡ªåŠ¨å¡«å……)'
        required: false
        default: '1'
      daemon_pid:
        description: 'OpenVPNå®ˆæŠ¤è¿›ç¨‹çš„PID (è‡ªåŠ¨å¡«å……)'
        required: false
        default: ''

jobs:
  run-on-ubuntu: # ä½œä¸šåç§°
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„Ubuntuç¯å¢ƒä¸Šè¿è¡Œ
    timeout-minutes: 15  # æœ€å¤§è¿è¡Œæ—¶é—´è®¾ç½®ä¸º15åˆ†é’Ÿï¼Œç¡®ä¿è§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯

    steps:
      # ä»…åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆæ²¡æœ‰çˆ¶è¿è¡ŒIDï¼‰æ—¶æ‰§è¡Œçš„æ­¥éª¤
      - name: æ£€å‡ºä»£ç 
        if: ${{ github.event.inputs.parent_run_id == '' }}
        uses: actions/checkout@v4 # ä½¿ç”¨actions/checkout@v4æ¥æ£€å‡ºä»£ç ä»“åº“

      # --- Step 2: å¯åŠ¨ OpenVPN å®ˆæŠ¤è¿›ç¨‹å¹¶éªŒè¯å‡ºå£IPå›½å®¶ ---
      # OpenVPN è¿›ç¨‹åœ¨æ­¤æ­¥éª¤å¯åŠ¨å¹¶ä¿æŒè¿è¡Œï¼Œå¹¶é€šè¿‡éªŒè¯å‡ºå£IPæ¥ç¡®è®¤è¿æ¥æˆåŠŸ
      - name: å¯åŠ¨OpenVPNå®ˆæŠ¤è¿›ç¨‹
        id: start-vpn
        if: ${{ github.event.inputs.parent_run_id == '' }}
        run: |
          #!/bin/bash
          set -eu

          # OpenVPN å®ˆæŠ¤è¿›ç¨‹çš„ PID æ–‡ä»¶è·¯å¾„
          PID_FILE="/tmp/openvpn_daemon.pid"

          echo "--- [é˜¶æ®µ 1/3] å¯åŠ¨ OpenVPN å®ˆæŠ¤è¿›ç¨‹ ---"
          echo "ğŸ‘‹ å½“å‰æ˜¯ç¬¬ ${{ github.event.inputs.iteration || '1' }} è½®å¾ªç¯"

          echo "[VPN Setup] å®‰è£… OpenVPN è½¯ä»¶åŒ…..."
          if ! dpkg -s openvpn > /dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y openvpn
          else
            echo "[VPN Setup] OpenVPN è½¯ä»¶åŒ…å·²å®‰è£…."
          fi

          OPENVPN_CONFIG_CONTENT="${{ secrets.OPENVPN_CONFIG }}" # ä» Secrets è·å– VPN é…ç½®
          CONFIG_DIR="/etc/openvpn/client"
          CONFIG_FILE="${CONFIG_DIR}/client.conf"

          echo "[VPN Setup] åˆ›å»ºé…ç½®ç›®å½•: ${CONFIG_DIR}"
          sudo mkdir -p "${CONFIG_DIR}"
          sudo chmod 700 "${CONFIG_DIR}" # è®¾ç½®ç›®å½•æƒé™

          echo "[VPN Setup] åˆ›å»º OpenVPN é…ç½®æ–‡ä»¶: ${CONFIG_FILE}"
          echo "${OPENVPN_CONFIG_CONTENT}" | sudo sh -c "cat > ${CONFIG_FILE}"
          sudo chmod 600 "${CONFIG_FILE}" # è®¾ç½®æ–‡ä»¶æƒé™

          echo "[VPN Setup] ä½¿ç”¨ nohup å¯åŠ¨ OpenVPN å®ˆæŠ¤è¿›ç¨‹ (PID åˆ° ${PID_FILE})..."
          # ä½¿ç”¨ nohup å’Œ & è®© OpenVPN åœ¨åå°è¿è¡Œï¼Œå¹¶å°è¯•ä½¿å…¶åœ¨æ­¤æ­¥éª¤ç»“æŸåç»§ç»­å­˜åœ¨
          # --writepid å°†å®ˆæŠ¤è¿›ç¨‹çš„ PID å†™å…¥æ–‡ä»¶
          # --verb 3 æ§åˆ¶ OpenVPN è‡ªèº«çš„æ—¥å¿—çº§åˆ«
          # >/dev/null 2>&1 é‡å®šå‘ OpenVPN æ—¥å¿—åˆ°ç©ºï¼Œå‡å°‘ Actions æ—¥å¿—é‡
          nohup sudo openvpn --config "${CONFIG_FILE}" --writepid "${PID_FILE}" --verb 3 >/dev/null 2>&1 &
          # $! æ˜¯ nohup å‘½ä»¤çš„ PIDï¼Œä¸æ˜¯ OpenVPN å®ˆæŠ¤è¿›ç¨‹çš„ PID

          echo "[VPN Setup] ç­‰å¾… OpenVPN å®ˆæŠ¤è¿›ç¨‹ PID æ–‡ä»¶å‡ºç°å¹¶ç¡®è®¤è¿›ç¨‹è¿è¡Œ (æœ€å¤š 20 ç§’)..."
          WAIT_PID_TIMEOUT=20 # ç­‰å¾… PID æ–‡ä»¶å’Œè¿›ç¨‹å‡ºç°çš„æ—¶é—´
          END_WAIT_PID=$((SECONDS + WAIT_PID_TIMEOUT))
          daemon_pid=""

          # å¾ªç¯ç­‰å¾… PID æ–‡ä»¶å’Œè¿›ç¨‹
          while [ $SECONDS -lt $END_WAIT_PID ]; do
              if [ -f "${PID_FILE}" ] && [ -s "${PID_FILE}" ]; then # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
                   daemon_pid=$(cat "${PID_FILE}")
                   if ps -p "$daemon_pid" > /dev/null 2>&1; then # æ£€æŸ¥ PID æ˜¯å¦å¯¹åº”ä¸€ä¸ªè¿è¡Œçš„è¿›ç¨‹
                       echo "[VPN Setup] OpenVPN å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨ï¼ŒPID: $daemon_pid."
                       break # æ‰¾åˆ° PID ä¸”è¿›ç¨‹è¿è¡Œï¼Œè·³å‡ºå¾ªç¯
                   fi
              fi
              sleep 1 # æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
          done

          # æ£€æŸ¥æœ€ç»ˆæ˜¯å¦ç¡®è®¤å®ˆæŠ¤è¿›ç¨‹è¿è¡Œã€‚å¦‚æœå®ˆæŠ¤è¿›ç¨‹éƒ½æ²¡èµ·æ¥ï¼Œç›´æ¥å¤±è´¥ã€‚
          if [ -z "$daemon_pid" ] || ! ps -p "$daemon_pid" > /dev/null 2>&1; then # Check if daemon_pid is empty OR process not running
              echo "[VPN Setup] âœ— OpenVPN å®ˆæŠ¤è¿›ç¨‹æœªèƒ½åœ¨ ${WAIT_PID_TIMEOUT} ç§’å†…ç¡®è®¤è¿è¡Œã€‚å¯åŠ¨å¤±è´¥ã€‚"
              exit 1 # æ­¥éª¤å¤±è´¥
          fi

          echo "[VPN Setup] âœ“ OpenVPN å®ˆæŠ¤è¿›ç¨‹ç¡®è®¤è¿è¡Œã€‚"
          echo "daemon_pid=${daemon_pid}" >> $GITHUB_OUTPUT
          
          # ç­‰å¾…VPNè¿æ¥ç¨³å®š
          echo "[VPN Setup] ç­‰å¾…VPNè¿æ¥ç¨³å®š (10ç§’)..."
          sleep 10
        shell: bash # ä½¿ç”¨ bash æ‰§è¡Œè„šæœ¬

      - name: ä¸‹è½½ quick_start.sh è„šæœ¬å¹¶å®‰è£…1Panel
        id: download-script
        if: ${{ github.event.inputs.parent_run_id == '' }}
        run: |
          #!/bin/bash
          set -eux

          echo "--- [é˜¶æ®µ 2/3] ä¸‹è½½ quick_start.sh è„šæœ¬å¹¶å®‰è£…1Panel ---"

          echo "[Install] ä¸‹è½½ quick_start.sh è„šæœ¬å¹¶æ‰§è¡Œ..."
          curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh && sudo bash quick_start.sh

          echo "[Install] âœ“ 1Panel å®‰è£…å®Œæˆã€‚"
        shell: bash

      - name: æ¢å¤OpenVPNçŠ¶æ€ï¼ˆå¾ªç¯è¿è¡Œæ—¶ï¼‰
        if: ${{ github.event.inputs.parent_run_id != '' }}
        run: |
          echo "--- [å¾ªç¯] è¿™æ˜¯ç¬¬ ${{ github.event.inputs.iteration }} æ¬¡å¾ªç¯è¿è¡Œ ---"
          echo "ä¸Šä¸€æ¬¡è¿è¡ŒID: ${{ github.event.inputs.parent_run_id }}"
          echo "ç»§ç»­ç›‘æ§OpenVPNå®ˆæŠ¤è¿›ç¨‹ (PID: ${{ github.event.inputs.daemon_pid }})"
        shell: bash

      - name: ç­‰å¾…OpenVPNå®ˆæŠ¤è¿›ç¨‹ç»“æŸ
        id: wait-vpn
        run: |
          #!/bin/bash
          set -e

          # ä½¿ç”¨é€‚å½“çš„PID 
          if [ "${{ github.event.inputs.parent_run_id }}" = "" ]; then
            # é¦–æ¬¡è¿è¡Œï¼Œä½¿ç”¨å¯åŠ¨æ­¥éª¤å¾—åˆ°çš„PID
            DAEMON_PID="${{ steps.start-vpn.outputs.daemon_pid }}"
            echo "ä½¿ç”¨åˆå§‹å¯åŠ¨çš„å®ˆæŠ¤è¿›ç¨‹PID: ${DAEMON_PID}"
          else
            # å¾ªç¯è¿è¡Œï¼Œä½¿ç”¨ä¼ é€’çš„PID
            DAEMON_PID="${{ github.event.inputs.daemon_pid }}"
            echo "ä½¿ç”¨ä¼ é€’çš„å®ˆæŠ¤è¿›ç¨‹PID: ${DAEMON_PID}"
          fi
          
          echo "--- [é˜¶æ®µ 3/3] ç­‰å¾… OpenVPN å®ˆæŠ¤è¿›ç¨‹ (æœ‰é™ç­‰å¾…10åˆ†é’Ÿ) ---"
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ
          if ! ps -p "$DAEMON_PID" > /dev/null 2>&1; then
            echo "[Wait] OpenVPN å®ˆæŠ¤è¿›ç¨‹ (PID: $DAEMON_PID) ä¸åœ¨è¿è¡Œã€‚"
            echo "process_ended=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "[Wait] å‘ç° OpenVPN å®ˆæŠ¤è¿›ç¨‹ (PID: $DAEMON_PID) æ­£åœ¨è¿è¡Œã€‚ç­‰å¾…10åˆ†é’Ÿåè§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯..."
          
          # ç­‰å¾…è¿›ç¨‹è¿è¡ŒæŒ‡å®šæ—¶é—´ (600ç§’ = 10åˆ†é’Ÿ)
          MAX_WAIT_TIME=600
          counter=0
          while [ $counter -lt $MAX_WAIT_TIME ]; do
            # æ¯60ç§’è¾“å‡ºä¸€æ¬¡çŠ¶æ€
            if [ $((counter % 60)) -eq 0 ]; then
              echo "[Wait] OpenVPN å®ˆæŠ¤è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå·²ç­‰å¾… $counter ç§’ï¼Œè¿˜å‰© $((MAX_WAIT_TIME - counter)) ç§’..."
            fi
            
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ
            if ! ps -p "$DAEMON_PID" > /dev/null 2>&1; then
              echo "[Wait] OpenVPN å®ˆæŠ¤è¿›ç¨‹å·²ç»“æŸã€‚"
              echo "process_ended=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            sleep 1
            counter=$((counter + 1))
          done
          
          echo "[Wait] å·²ç­‰å¾…10åˆ†é’Ÿï¼Œå‡†å¤‡è§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯..."
          echo "process_ended=false" >> $GITHUB_OUTPUT
          echo "daemon_pid=$DAEMON_PID" >> $GITHUB_OUTPUT
        shell: bash

      - name: è§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯
        if: steps.wait-vpn.outputs.process_ended != 'true'
        run: |
          echo "OpenVPN å®ˆæŠ¤è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œæ­£åœ¨è§¦å‘ä¸‹ä¸€æ¬¡å¾ªç¯..."
          
          # è®¡ç®—ä¸‹ä¸€æ¬¡è¿­ä»£è®¡æ•°
          NEXT_ITERATION=$((${{ github.event.inputs.iteration || 1 }} + 1))
          echo "ä¸‹ä¸€æ¬¡å°†æ˜¯ç¬¬ $NEXT_ITERATION è½®å¾ªç¯"
          
          # è·å–å®ˆæŠ¤è¿›ç¨‹PID
          DAEMON_PID="${{ steps.wait-vpn.outputs.daemon_pid }}"
          
          # è§¦å‘ç›¸åŒå·¥ä½œæµ
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/ubuntu_openvpn.yml/dispatches \
            -d "{\"ref\":\"${{ github.ref }}\", \"inputs\": {\"parent_run_id\": \"${{ github.run_id }}\", \"iteration\": \"$NEXT_ITERATION\", \"daemon_pid\": \"$DAEMON_PID\"}}"
          
          echo "å·²è§¦å‘ä¸‹ä¸€è½®å¾ªç¯ (#$NEXT_ITERATION)"
        shell: bash
